{
  "openapi": "3.0.3",
  "info": {
    "title": "TREX API",
    "description": "TREX API",
    "version": "0.1.0",
    "contact": {
      "name": "Megware",
      "url": "megware.com",
      "email": "info@megware.com"
    },
    "license": {
      "name": "TODO"
    }
  },
  "servers": [
    {
      "url": "/v1",
      "description": "batch server"
    }
  ],
  "paths": {
    "/state": {
      "get": {
        "tags": [
          "batch"
        ],
        "description": "Get batchsystem state",
        "security": [
          {
            "oauth2": [
              "batch_detect"
            ]
          }
        ],
        "responses": {
          "200": {
            "description": "Batchsystem state",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "data": {
                      "type": "object",
                      "properties": {
                        "detected": {
                          "type": "boolean",
                          "description": "Whether batchsystem is available"
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/batchinfo": {
      "get": {
        "tags": [
          "batch"
        ],
        "description": "Get batchsystem information",
        "security": [
          {
            "oauth2": [
              "batch_info"
            ]
          }
        ],
        "responses": {
          "200": {
            "description": "Batchsystem information",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "data": {
                      "$ref": "#/components/schemas/Batchinfo"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/queues": {
      "get": {
        "tags": [
          "queues"
        ],
        "description": "Get queues",
        "security": [
          {
            "oauth2": [
              "queues_info"
            ]
          }
        ],
        "responses": {
          "200": {
            "description": "Queues information",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "data": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/Queue"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/nodes": {
      "get": {
        "tags": [
          "nodes"
        ],
        "description": "Get nodes",
        "security": [
          {
            "oauth2": [
              "nodes_info"
            ]
          }
        ],
        "responses": {
          "200": {
            "description": "Nodes information",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "data": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/Node"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/jobs": {
      "get": {
        "tags": [
          "jobs"
        ],
        "description": "Get jobs",
        "security": [
          {
            "oauth2": [
              "jobs_info"
            ]
          }
        ],
        "responses": {
          "200": {
            "description": "Jobs information",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "data": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/Job"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/jobs/*/submit": {
      "post": {
        "tags": [
          "jobs"
        ],
        "description": "Get jobs",
        "security": [
          {
            "oauth2": [
              "jobs_submit"
            ]
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/JobOptions"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "Jobs information",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "data": {
                      "type": "object",
                      "properties": {
                        "job": {
                          "type": "string",
                          "description": "Id of submitted job"
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/jobs/{job_id}": {
      "delete": {
        "tags": [
          "jobs"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/JobId"
          },
          {
            "$ref": "#/components/parameters/Force"
          }
        ],
        "description": "Delete job by id",
        "security": [
          {
            "oauth2": [
              "jobs_delete"
            ]
          }
        ],
        "responses": {
          "204": {
            "description": "Deleted successfully"
          }
        }
      }
    },
    "/jobs/*": {
      "delete": {
        "tags": [
          "jobs"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/BatchUser"
          }
        ],
        "description": "Delete job by user",
        "security": [
          {
            "oauth2": [
              "jobs_user_delete"
            ]
          }
        ],
        "responses": {
          "204": {
            "description": "Deleted successfully"
          }
        }
      }
    },
    "/jobs/{job_id}/hold": {
      "post": {
        "tags": [
          "jobs"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/JobId"
          }
        ],
        "description": "Hold job",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "force": {
                    "type": "boolean",
                    "default": false
                  }
                }
              }
            }
          }
        },
        "security": [
          {
            "oauth2": [
              "jobs_hold"
            ]
          }
        ],
        "responses": {
          "200": {
            "description": "Holded successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CommandReturn"
                }
              }
            }
          }
        }
      }
    },
    "/jobs/{job_id}/release": {
      "post": {
        "tags": [
          "jobs"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/JobId"
          }
        ],
        "description": "Release job",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "force": {
                    "type": "boolean",
                    "default": false
                  }
                }
              }
            }
          }
        },
        "security": [
          {
            "oauth2": [
              "jobs_release"
            ]
          }
        ],
        "responses": {
          "200": {
            "description": "Released successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CommandReturn"
                }
              }
            }
          }
        }
      }
    },
    "/jobs/{job_id}/suspend": {
      "post": {
        "tags": [
          "jobs"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/JobId"
          }
        ],
        "description": "Suspend job",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "force": {
                    "type": "boolean",
                    "default": false
                  }
                }
              }
            }
          }
        },
        "security": [
          {
            "oauth2": [
              "jobs_suspend"
            ]
          }
        ],
        "responses": {
          "200": {
            "description": "Suspended successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CommandReturn"
                }
              }
            }
          }
        }
      }
    },
    "/jobs/{job_id}/resume": {
      "post": {
        "tags": [
          "jobs"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/JobId"
          }
        ],
        "description": "Resume job",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "force": {
                    "type": "boolean",
                    "default": false
                  }
                }
              }
            }
          }
        },
        "security": [
          {
            "oauth2": [
              "jobs_resume"
            ]
          }
        ],
        "responses": {
          "200": {
            "description": "Resumed successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CommandReturn"
                }
              }
            }
          }
        }
      }
    },
    "/jobs/{job_id}/reschedule": {
      "post": {
        "tags": [
          "jobs"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/JobId"
          }
        ],
        "description": "Reschedule job",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "force": {
                    "type": "boolean",
                    "default": false
                  }
                }
              }
            }
          }
        },
        "security": [
          {
            "oauth2": [
              "jobs_reschedule"
            ]
          }
        ],
        "responses": {
          "200": {
            "description": "Rescheduled successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CommandReturn"
                }
              }
            }
          }
        }
      }
    },
    "/nodes/{node_id}/comment": {
      "post": {
        "tags": [
          "nodes"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/NodeId"
          }
        ],
        "description": "Change node comment",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "comment"
                ],
                "properties": {
                  "force": {
                    "type": "boolean",
                    "default": false
                  },
                  "comment": {
                    "type": "string"
                  },
                  "append": {
                    "type": "boolean",
                    "default": false
                  }
                }
              }
            }
          }
        },
        "security": [
          {
            "oauth2": [
              "nodes_comment_edit"
            ]
          }
        ],
        "responses": {
          "200": {
            "description": "Changed successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CommandReturn"
                }
              }
            }
          }
        }
      }
    },
    "/nodes/{node_id}/state": {
      "post": {
        "tags": [
          "nodes"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/NodeId"
          }
        ],
        "description": "Change node state",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "state"
                ],
                "properties": {
                  "state": {
                    "type": "string",
                    "enum": [
                      "resume",
                      "drain",
                      "undrain"
                    ]
                  },
                  "force": {
                    "type": "boolean",
                    "default": false
                  },
                  "reason": {
                    "type": "string"
                  },
                  "append": {
                    "type": "boolean",
                    "default": false
                  }
                }
              }
            }
          }
        },
        "security": [
          {
            "oauth2": [
              "nodes_state_edit"
            ]
          }
        ],
        "responses": {
          "200": {
            "description": "Changed successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CommandReturn"
                }
              }
            }
          }
        }
      }
    },
    "/queues/{queue_id}/state": {
      "post": {
        "tags": [
          "queues"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/QueueId"
          }
        ],
        "description": "Change queue state",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "state"
                ],
                "properties": {
                  "state": {
                    "type": "string",
                    "enum": [
                      "open",
                      "closed",
                      "inactive",
                      "draining"
                    ]
                  },
                  "force": {
                    "type": "boolean",
                    "default": false
                  }
                }
              }
            }
          }
        },
        "security": [
          {
            "oauth2": [
              "queues_state_edit"
            ]
          }
        ],
        "responses": {
          "200": {
            "description": "Changed successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CommandReturn"
                }
              }
            }
          }
        }
      }
    },
    "/users": {
      "post": {
        "tags": [
          "users"
        ],
        "description": "Add user",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/User"
              }
            }
          }
        },
        "security": [
          {
            "oauth2": [
              "users_add"
            ]
          }
        ],
        "responses": {
          "201": {
            "description": "Added successfully"
          }
        }
      }
    },
    "/users/{user_name}": {
      "patch": {
        "tags": [
          "users"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/User"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/User"
              }
            }
          }
        },
        "description": "Patch user",
        "security": [
          {
            "oauth2": [
              "users_edit"
            ]
          }
        ],
        "responses": {
          "201": {
            "description": "Patched successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/User"
                }
              }
            }
          }
        }
      },
      "delete": {
        "tags": [
          "users"
        ],
        "parameters": [
          {
            "$ref": "#/components/parameters/User"
          }
        ],
        "description": "Delete user",
        "security": [
          {
            "oauth2": [
              "users_delete"
            ]
          }
        ],
        "responses": {
          "200": {
            "description": "Deleted successfully"
          }
        }
      }
    }
  },
  "components": {
    "parameters": {
      "JobId": {
        "name": "job_id",
        "in": "path",
        "required": true,
        "description": "Id of job",
        "schema": {
          "type": "string"
        }
      },
      "QueueId": {
        "name": "queue_id",
        "in": "path",
        "required": true,
        "description": "Id of queue",
        "schema": {
          "type": "string"
        }
      },
      "NodeId": {
        "name": "node_id",
        "in": "path",
        "required": true,
        "description": "Id of node",
        "schema": {
          "type": "string"
        }
      },
      "User": {
        "name": "user_name",
        "in": "path",
        "required": true,
        "description": "Username",
        "schema": {
          "type": "string"
        }
      },
      "Force": {
        "name": "force",
        "description": "Force command",
        "in": "query",
        "schema": {
          "type": "boolean",
          "default": false
        }
      },
      "BatchUser": {
        "name": "user",
        "description": "Batchsystem username",
        "in": "query",
        "required": true,
        "schema": {
          "type": "string"
        }
      }
    },
    "schemas": {
      "CommandReturn": {
        "type": "object",
        "properties": {
          "data": {
            "type": "object",
            "properties": {
              "success": {
                "type": "boolean"
              }
            }
          }
        }
      },
      "Batchinfo": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string",
            "description": "Name of the batchsystem"
          },
          "version": {
            "type": "string",
            "description": "Version of the batchsystem"
          },
          "info": {
            "type": "object",
            "description": "Additional batchsystem metadata",
            "additionalProperties": {
              "x-additionalPropertiesName": "key",
              "type": "string"
            }
          }
        }
      },
      "User": {
        "type": "object",
        "required": [
          "user",
          "password"
        ],
        "properties": {
          "user": {
            "type": "string"
          },
          "password": {
            "type": "string"
          },
          "scopes": {
            "type": "array",
            "items": {
              "type": "string"
            }
          }
        }
      },
      "Node": {
        "type": "object",
        "required": [
          "name"
        ],
        "properties": {
          "name": {
            "type": "string"
          },
          "nameFull": {
            "type": "string"
          },
          "state": {
            "type": "string",
            "enum": [
              "unknown",
              "various",
              "online",
              "offline",
              "disabled",
              "powersave",
              "reserved",
              "maintainence",
              "failed"
            ]
          },
          "rawState": {
            "type": "string"
          },
          "comment": {
            "type": "string"
          },
          "reason": {
            "type": "string"
          },
          "cpus": {
            "type": "integer"
          },
          "cpusReserved": {
            "type": "integer"
          },
          "cpusUsed": {
            "type": "integer"
          },
          "cpusOfJobs": {
            "type": "object",
            "additionalProperties": {
              "x-additionalPropertiesName": "cpus",
              "type": "integer"
            }
          }
        }
      },
      "Job": {
        "type": "object",
        "required": [
          "id"
        ],
        "properties": {
          "id": {
            "type": "string"
          },
          "idCompact": {
            "type": "string"
          },
          "name": {
            "type": "string"
          },
          "owner": {
            "type": "string"
          },
          "user": {
            "type": "string"
          },
          "userId": {
            "type": "integer"
          },
          "group": {
            "type": "string"
          },
          "groupId": {
            "type": "integer"
          },
          "queue": {
            "type": "string"
          },
          "priority": {
            "type": "integer"
          },
          "execHost": {
            "type": "string"
          },
          "submitHost": {
            "type": "string"
          },
          "server": {
            "type": "string"
          },
          "state": {
            "type": "string",
            "enum": [
              "unknown",
              "running",
              "queued",
              "requeued",
              "terminating",
              "finished",
              "cancelled",
              "failed",
              "moved",
              "suspend",
              "zombie"
            ]
          },
          "rawState": {
            "type": "string"
          },
          "workdir": {
            "type": "string"
          },
          "exitCode": {
            "type": "integer"
          },
          "exitSignal": {
            "type": "integer"
          },
          "submitArgs": {
            "type": "string"
          },
          "comment": {
            "type": "object",
            "properties": {
              "reason": {
                "type": "string"
              },
              "user": {
                "type": "string"
              },
              "admin": {
                "type": "string"
              },
              "system": {
                "type": "string"
              }
            }
          },
          "time": {
            "type": "object",
            "properties": {
              "submit": {
                "type": "integer"
              },
              "start": {
                "type": "integer"
              },
              "end": {
                "type": "integer"
              },
              "queue": {
                "type": "integer"
              }
            }
          },
          "used": {
            "type": "object",
            "properties": {
              "cpusPerNode": {
                "type": "integer"
              },
              "cpus": {
                "type": "integer"
              },
              "nodes": {
                "type": "integer"
              },
              "wallTime": {
                "type": "integer"
              },
              "cpuTime": {
                "type": "integer"
              },
              "mem": {
                "type": "integer"
              },
              "vmem": {
                "type": "integer"
              }
            }
          },
          "requested": {
            "type": "object",
            "properties": {
              "other": {
                "type": "integer"
              },
              "nice": {
                "type": "integer"
              },
              "cpus": {
                "type": "integer"
              },
              "nodes": {
                "type": "integer"
              },
              "wallTime": {
                "type": "integer"
              },
              "general": {
                "type": "object",
                "additionalProperties": {
                  "x-additionalPropertiesName": "resource",
                  "type": "string"
                }
              }
            }
          },
          "cpusFromNode": {
            "type": "object",
            "additionalProperties": {
              "x-additionalPropertiesName": "node",
              "type": "integer"
            }
          },
          "variableList": {
            "type": "object",
            "description": "Environment variables",
            "additionalProperties": {
              "x-additionalPropertiesName": "key",
              "type": "string"
            }
          }
        }
      },
      "Queue": {
        "type": "object",
        "required": [
          "name"
        ],
        "properties": {
          "name": {
            "type": "string"
          },
          "priority": {
            "type": "integer"
          },
          "state": {
            "type": "string",
            "enum": [
              "unknown",
              "open",
              "closed",
              "inactive",
              "draining"
            ]
          },
          "rawState": {
            "type": "string"
          },
          "jobs": {
            "type": "object",
            "properties": {
              "total": {
                "type": "integer"
              },
              "pending": {
                "type": "integer"
              },
              "running": {
                "type": "integer"
              },
              "suspended": {
                "type": "integer"
              }
            }
          },
          "cpus": {
            "type": "integer"
          },
          "nodesTotal": {
            "type": "integer"
          },
          "nodesMin": {
            "type": "integer"
          },
          "nodesMax": {
            "type": "integer"
          },
          "wallTimeMax": {
            "type": "integer"
          },
          "memPerCpuMax": {
            "type": "integer"
          },
          "modifyTime": {
            "type": "integer"
          },
          "nodes": {
            "type": "array",
            "items": {
              "type": "string"
            }
          }
        }
      },
      "JobOptions": {
        "type": "object",
        "properties": {
          "path": {
            "type": "string"
          },
          "nodes": {
            "type": "integer"
          },
          "nodesMax": {
            "type": "integer"
          },
          "tasks": {
            "type": "integer"
          },
          "gpus": {
            "type": "integer"
          }
        }
      }
    },
    "securitySchemes": {
      "oauth2": {
        "type": "oauth2",
        "flows": {
          "implicit": {
            "authorizationUrl": "/",
            "scopes": {
              "users_edit": "Edit existing system user",
              "users_add": "Add new system user",
              "users_delete": "Delete system user",
              "jobs_submit": "Submit a batchsystem job",
              "jobs_delete": "Delete a batchsystem job by id",
              "jobs_user_delete": "Delete bathsystem jobs by user",
              "nodes_state_edit": "Edit node state",
              "queues_state_edit": "Edit queue state",
              "nodes_comment_edit": "Edit node comment",
              "jobs_hold": "Hold job",
              "jobs_release": "Release job",
              "jobs_suspend": "Suspend job",
              "jobs_resume": "Resume job",
              "jobs_reschedule": "Reschedule job in queue",
              "jobs_info": "Get job infos",
              "queues_info": "Get queue infos",
              "nodes_info": "Get node infos",
              "batch_info": "Get batchsystem infos",
              "batch_detect": "Detect batchsystem support"
            }
          }
        }
      }
    }
  }
}